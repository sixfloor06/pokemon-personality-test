<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>宝可梦性格测试（答题 + 生日八字）</title>
<style>
  :root {
    --bg:#0b0f17; --card:#121a27; --muted:#94a3b8; --text:#e5e7eb; --line:#243244;
  }
  body{margin:0;background:linear-gradient(180deg,var(--bg),#070a10);color:var(--text);
       font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Noto Sans SC","Helvetica Neue",Arial,sans-serif;}
  .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px;}
  .top{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;}
  .title{flex:1;min-width:300px;}
  h1{margin:0 0 8px;font-size:22px;letter-spacing:.2px;}
  .sub{color:var(--muted);line-height:1.5;font-size:13px;}
  .card{background:rgba(18,26,39,.92);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25);}
  .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px;}
  @media (min-width:980px){.grid{grid-template-columns:1.25fr .75fr;}}
  .q{border:1px solid var(--line);border-radius:12px;padding:14px;background:rgba(255,255,255,.02);}
  .qhead{display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:10px;}
  .qid{font-size:12px;color:var(--muted);}
  .qtext{font-size:15px;line-height:1.45;}
  .btns{display:flex;gap:10px;}
  button{cursor:pointer;border:1px solid var(--line);background:#0f172a;color:var(--text);padding:10px 12px;border-radius:10px;font-weight:700;}
  button:hover{border-color:#35507a;}
  button.sel-yes{border-color:rgba(52,211,153,.7);box-shadow:0 0 0 2px rgba(52,211,153,.12) inset;}
  button.sel-no{border-color:rgba(251,113,133,.7);box-shadow:0 0 0 2px rgba(251,113,133,.10) inset;}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
  .primary{background:linear-gradient(90deg,#2563eb,#60a5fa);border-color:transparent;}
  .ghost{background:transparent;}
  .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(96,165,250,.12);border:1px solid rgba(96,165,250,.25);
        padding:6px 10px;border-radius:999px;margin:6px 6px 0 0;font-size:12px;color:#cfe6ff;}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;color:#cbd5e1;}
  .small{font-size:12px;color:var(--muted);line-height:1.45;}
  .sep{height:1px;background:var(--line);margin:12px 0;}
  label{display:block;font-size:12px;color:var(--muted);margin:8px 0 6px;}
  input{width:100%;box-sizing:border-box;border:1px solid var(--line);border-radius:10px;background:#0f172a;color:var(--text);padding:10px 10px;}
  .row{display:grid;grid-template-columns:1fr;gap:10px;}
  @media (min-width:680px){.row{grid-template-columns:1fr 1fr;}}
  .bar{height:10px;background:#0c1220;border:1px solid var(--line);border-radius:999px;overflow:hidden;}
  .bar > div{height:100%;background:linear-gradient(90deg,#34d399,#60a5fa);}
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lunar-javascript/1.6.3/lunar.min.js"></script>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div class="title card">
      <h1>宝可梦性格测试（答题 + 生日八字）</h1>
      <div class="sub">
        你只需要：<strong>回答10题</strong> + <strong>填写生日（可选时间）</strong>。<br/>
        系统将“显性行为”（答题）作为主导，“命格底色”（八字五行）作为校准，并在最终属性池内做细分排序，输出唯一初始形态宝可梦。
      </div>
    </div>
    <div class="card" style="min-width:300px;flex:0.9">
      <div class="small"><strong>数据库概况</strong></div>
      <div class="sep"></div>
      <div class="small" id="poolStats">加载中…</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="small"><strong>生日信息</strong>（用于八字五行；不填则只按答题）</div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>生日（公历）</label>
          <input type="date" id="birthDate" />
        </div>
        <div>
          <label>出生时间（可选）</label>
          <input type="time" id="birthTime" step="60" />
          <div class="small">不填默认 12:00</div>
        </div>
      </div>

      <div class="sep"></div>
      <div class="small"><strong>答题区</strong>（10题必须全部选择）</div>
      <div id="quiz" style="margin-top:10px;"></div>

      <div class="actions">
        <button class="primary" id="calcBtn">生成我的宝可梦</button>
        <button class="ghost" id="resetBtn">重置</button>
      </div>
      <div class="small" id="msg" style="margin-top:10px;"></div>

      <div class="sep"></div>
      <div class="small"><strong>规则快照（只读）</strong></div>
      <div class="small">
        1) 双属性宝可梦：<strong>仅取主属性</strong>；2) 答题主导、八字校准；3) 池内先排序再落点，确保可复现。
      </div>
    </div>

    <div class="card">
      <div style="font-size:18px;font-weight:900;margin-bottom:8px;">结果</div>
      <div class="small">完成左侧后点击「生成我的宝可梦」。</div>
      <div class="sep"></div>
      <div id="result"></div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">
    <div class="small"><strong>内嵌配置</strong></div>
    <div class="sep"></div>
    <div class="small">
      已内嵌：属性↔五行宪法、五行→原型先验、属性→默认行为标签、原型→成长叙事，以及“已移除传说/幻”的初始形态池。
    </div>
  </div>
</div>

<script>

const CONFIG = {
  alpha: 0.78,
  beta: 0.18,
  type_to_wuxing: {"Normal":"Earth","Fire":"Fire","Water":"Water","Grass":"Wood","Electric":"Fire","Ice":"Water","Fighting":"Fire","Poison":"Metal","Ground":"Earth","Flying":"Wood","Psychic":"Fire","Bug":"Wood","Rock":"Earth","Ghost":"Water","Dragon":"Metal","Dark":"Water","Steel":"Metal","Fairy":"Wood"},
  wuxing_to_archetype_prior: {"Wood":{"F1":2,"B1":2,"G1":2,"A1":1,"E1":1},"Fire":{"A1":2,"D1":2,"C1":2,"F1":1,"B1":1},"Earth":{"A2":2,"F2":2,"E1":2,"E2":1,"G2":1},"Water":{"C2":2,"D2":2,"G1":2,"B2":1,"E2":1},"Metal":{"B2":2,"G2":2,"E2":2,"A2":1,"F2":1}},
  type_to_default_archetype_tags: {"Fire":["A1","D1","C1"],"Electric":["A1","C1","F1"],"Fighting":["D1","A1","C1"],"Psychic":["B2","C2","A2"],"Water":["C2","D2","G1"],"Ice":["C2","B2","D2"],"Ghost":["C2","D2","E2"],"Dark":["D2","G2","B2"],"Grass":["A2","F1","E1"],"Bug":["F1","G1","E1"],"Flying":["F1","A1","E1"],"Fairy":["E1","C1","F1"],"Steel":["B2","G2","A2"],"Poison":["G1","C2","B1"],"Dragon":["B2","A2","D1"],"Ground":["A2","F2","G2"],"Rock":["F2","A2","G2"],"Normal":["A2","E1","F2"]},
  growth_arc_by_top1: {"A1":"burst_leap","D1":"burst_leap","C1":"burst_leap","F1":"burst_leap","B1":"burst_leap","A2":"stable_accumulate","F2":"stable_accumulate","B2":"stable_accumulate","G2":"stable_accumulate","E1":"stable_accumulate","E2":"stable_accumulate","G1":"condition_trigger","D2":"condition_trigger","C2":"condition_trigger"},
  type_zh: {"Normal":"一般","Fire":"火","Water":"水","Grass":"草","Electric":"电","Ice":"冰","Fighting":"格斗","Poison":"毒","Ground":"地面","Flying":"飞行","Psychic":"超能","Bug":"虫","Rock":"岩石","Ghost":"幽灵","Dragon":"龙","Dark":"恶","Steel":"钢","Fairy":"妖精"},
  wuxing_zh: {"Wood":"木","Fire":"火","Earth":"土","Metal":"金","Water":"水"}
};
const POOLS = {"Normal":[[16,"pidgey","波波"],[19,"rattata","小拉达"],[21,"spearow","烈雀"],[52,"meowth","喵喵"],[83,"farfetchd","大葱鸭"],[84,"doduo","嘟嘟"],[108,"lickitung","大舌头"],[115,"kangaskhan","袋兽"],[128,"tauros","肯泰罗"],[132,"ditto","百变怪"],[133,"eevee","伊布"],[137,"porygon","多边兽"],[161,"sentret","尾立"],[163,"hoothoot","咕咕"],[174,"igglybuff","宝宝丁"],[190,"aipom","长尾怪手"],[203,"girafarig","麒麟奇"],[206,"dunsparce","土龙弟弟"],[216,"teddiursa","熊宝宝"],[234,"stantler","惊角鹿"],[235,"smeargle","图图犬"],[241,"miltank","大奶罐"],[263,"zigzagoon","蛇纹熊"],[276,"taillow","傲骨燕"],[287,"slakoth","懒人獭"],[293,"whismur","咕妞妞"],[298,"azurill","露力丽"],[300,"skitty","向尾喵"],[327,"spinda","晃晃斑"],[333,"swablu","青绵鸟"],[335,"zangoose","猫鼬斩"],[351,"castform","飘浮泡泡"],[352,"kecleon","变隐龙"],[396,"starly","姆克儿"],[399,"bidoof","大牙狸"],[427,"buneary","卷卷耳"],[431,"glameow","魅力喵"],[440,"happiny","小福蛋"],[441,"chatot","聒噪鸟"],[446,"munchlax","小卡比兽"],[504,"patrat","探探鼠"],[506,"lillipup","小约克"],[519,"pidove","豆豆鸽"],[531,"audino","差不多娃娃"],[572,"minccino","泡沫栗鼠"],[585,"deerling","四季鹿"],[626,"bouffalant","爆炸头水牛"],[627,"rufflet","毛头小鹰"],[659,"bunnelby","掘掘兔"],[661,"fletchling","小箭雀"],[676,"furfrou","多丽米亚"],[731,"pikipek","小笃儿"],[734,"yungoos","猫鼬少"],[759,"stufful","童偶熊"],[765,"oranguru","智挥猩"],[775,"komala","树枕尾熊"],[780,"drampa","老翁龙"],[819,"skwovet","贪心栗鼠"],[831,"wooloo","毛辫羊"],[915,"lechonk","爱吃豚"],[924,"tandemaus","一对鼠"],[931,"squawkabilly","怒鹦哥"]],"Fighting":[[56,"mankey","猴怪"],[66,"machop","腕力"],[236,"tyrogue","无畏小子"],[296,"makuhita","幕下力士"],[307,"meditite","玛沙那"],[447,"riolu","利欧路"],[532,"timburr","搬运小匠"],[538,"throh","投摔鬼"],[539,"sawk","打击鬼"],[619,"mienfoo","功夫鼬"],[674,"pancham","顽皮熊猫"],[701,"hawlucha","摔角鹰人"],[739,"crabrawler","好胜蟹"],[766,"passimian","投掷猴"],[852,"clobbopus","拳拳蛸"],[870,"falinks","列阵兵"]],"Flying":[[714,"noibat","嗡蝠"],[821,"rookidee","稚山雀"],[845,"cramorant","古月鸟"],[962,"bombirdier","下石鸟"],[973,"flamigo","纏红鹤"]],"Poison":[[23,"ekans","阿柏蛇"],[29,"nidoran-f","尼多兰"],[32,"nidoran-m","尼多朗"],[41,"zubat","超音蝠"],[88,"grimer","臭泥"],[109,"koffing","瓦斯弹"],[316,"gulpin","溶食兽"],[336,"seviper","饭匙蛇"],[434,"stunky","臭鼬噗"],[451,"skorupi","钳尾蝎"],[453,"croagunk","不良蛙"],[568,"trubbish","破破袋"],[690,"skrelp","垃垃藻"],[747,"mareanie","好坏星"],[757,"salandit","夜盗火蜥"],[944,"shroodle","滋汁鼹"]],"Ground":[[27,"sandshrew","穿山鼠"],[50,"diglett","地鼠"],[104,"cubone","卡拉卡拉"],[111,"rhyhorn","独角犀牛"],[207,"gligar","天蝎"],[231,"phanpy","小小象"],[328,"trapinch","大颚蚁"],[343,"baltoy","天秤偶"],[449,"hippopotas","沙河马"],[529,"drilbur","螺钉地鼠"],[551,"sandile","黑眼鳄"],[618,"stunfisk","泥巴鱼"],[622,"golett","泥偶小人"],[749,"mudbray","泥驴仔"],[843,"silicobra","沙包蛇"],[948,"toedscool","原野水母"]],"Rock":[[74,"geodude","小拳石"],[95,"onix","大岩蛇"],[138,"omanyte","菊石兽"],[140,"kabuto","化石盔"],[142,"aerodactyl","化石翼龙"],[246,"larvitar","幼基拉斯"],[299,"nosepass","朝北鼻"],[337,"lunatone","月石"],[338,"solrock","太阳岩"],[345,"lileep","触手百合"],[347,"anorith","太古羽虫"],[408,"cranidos","头盖龙"],[410,"shieldon","盾甲龙"],[438,"bonsly","盆才怪"],[524,"roggenrola","石丸子"],[566,"archen","始祖小鸟"],[688,"binacle","龟脚脚"],[696,"tyrunt","宝宝暴龙"],[698,"amaura","冰雪龙"],[703,"carbink","小碎钻"],[744,"rockruff","岩狗狗"],[774,"minior","小陨星"],[837,"rolycoly","小炭仔"],[874,"stonjourner","巨石丁"],[932,"nacli","盐石宝"],[950,"klawf","毛崖蟹"],[969,"glimmet","晶光芽"]],"Bug":[[10,"caterpie","绿毛虫"],[13,"weedle","独角虫"],[46,"paras","派拉斯"],[48,"venonat","毛球"],[123,"scyther","飞天螳螂"],[127,"pinsir","凯罗斯"],[165,"ledyba","芭瓢虫"],[167,"spinarak","圆丝蛛"],[193,"yanma","蜻蜻蜓"],[204,"pineco","榛果球"],[213,"shuckle","壶壶"],[214,"heracross","赫拉克罗斯"],[265,"wurmple","刺尾虫"],[283,"surskit","溜溜糖球"],[290,"nincada","土居忍士"],[313,"volbeat","电萤虫"],[314,"illumise","甜甜萤"],[401,"kricketot","圆法师"],[412,"burmy","结草儿"],[415,"combee","三蜜蜂"],[540,"sewaddle","虫宝包"],[543,"venipede","百足蜈蚣"],[557,"dwebble","石居蟹"],[588,"karrablast","盖盖虫"],[595,"joltik","电电虫"],[616,"shelmet","小嘴蜗"],[632,"durant","铁蚁"],[636,"larvesta","燃烧虫"],[664,"scatterbug","粉蝶虫"],[736,"grubbin","强颚鸡母虫"],[742,"cutiefly","萌虻"],[767,"wimpod","胆小虫"],[824,"blipbug","索侦虫"],[917,"tarountula","团珠蛛"],[919,"nymble","豆蟋蟀"],[953,"rellor","虫滚泥"]],"Ghost":[[92,"gastly","鬼斯"],[200,"misdreavus","梦妖"],[353,"shuppet","怨影娃娃"],[355,"duskull","夜巡灵"],[425,"drifloon","飘飘球"],[442,"spiritomb","花岩怪"],[562,"yamask","哭哭面具"],[607,"litwick","烛光灵"],[708,"phantump","小木灵"],[710,"pumpkaboo","南瓜精"],[769,"sandygast","沙丘娃"],[778,"mimikyu","谜拟丘"],[781,"dhelmise","破破舵轮"],[854,"sinistea","来悲茶"],[971,"greavard","墓仔狗"],[999,"gimmighoul","索财灵"]],"Steel":[[227,"skarmory","盔甲鸟"],[303,"mawile","大嘴娃"],[304,"aron","可可多拉"],[374,"beldum","铁哑铃"],[436,"bronzor","铜镜怪"],[599,"klink","齿轮儿"],[679,"honedge","独剑鞘"],[707,"klefki","钥圈儿"],[878,"cufant","铜象"],[884,"duraludon","铝钢龙"],[965,"varoom","噗隆隆"],[968,"orthworm","拖拖蚓"]],"Fire":[[4,"charmander","小火龙"],[37,"vulpix","六尾"],[58,"growlithe","卡蒂狗"],[77,"ponyta","小火马"],[155,"cyndaquil","火球鼠"],[218,"slugma","熔岩虫"],[240,"magby","鸭嘴宝宝"],[255,"torchic","火稚鸡"],[322,"numel","呆火驼"],[324,"torkoal","煤炭龟"],[390,"chimchar","小火焰猴"],[498,"tepig","暖暖猪"],[513,"pansear","爆香猴"],[554,"darumaka","火红不倒翁"],[631,"heatmor","熔蚁兽"],[653,"fennekin","火狐狸"],[667,"litleo","小狮狮"],[725,"litten","火斑喵"],[741,"oricorio","花舞鸟"],[776,"turtonator","爆焰龟兽"],[813,"scorbunny","炎兔儿"],[850,"sizzlipede","烧火蚣"],[909,"fuecoco","呆火鳄"],[935,"charcadet","炭小侍"]],"Water":[[7,"squirtle","杰尼龟"],[54,"psyduck","可达鸭"],[60,"poliwag","蚊香蝌蚪"],[72,"tentacool","玛瑙水母"],[79,"slowpoke","呆呆兽"],[86,"seel","小海狮"],[90,"shellder","大舌贝"],[98,"krabby","大钳蟹"],[116,"horsea","墨海马"],[118,"goldeen","角金鱼"],[120,"staryu","海星星"],[129,"magikarp","鲤鱼王"],[131,"lapras","拉普拉斯"],[158,"totodile","小锯鳄"],[170,"chinchou","灯笼鱼"],[194,"wooper","乌波"],[211,"qwilfish","千针鱼"],[222,"corsola","太阳珊瑚"],[223,"remoraid","铁炮鱼"],[258,"mudkip","水跃鱼"],[270,"lotad","莲叶童子"],[278,"wingull","长翅鸥"],[318,"carvanha","利牙鱼"],[320,"wailmer","吼吼鲸"],[339,"barboach","泥泥鳅"],[341,"corphish","龙虾小兵"],[349,"feebas","丑丑鱼"],[366,"clamperl","珍珠贝"],[369,"relicanth","古空棘鱼"],[370,"luvdisc","爱心鱼"],[393,"piplup","波加曼"],[418,"buizel","泳圈鼬"],[422,"shellos","无壳海兔"],[456,"finneon","荧光鱼"],[458,"mantyke","小球飞鱼"],[501,"oshawott","水水獭"],[515,"panpour","冷水猴"],[535,"tympole","圆蝌蚪"],[550,"basculin","野蛮鲈鱼"],[564,"tirtouga","原盖海龟"],[580,"ducklett","鸭宝宝"],[592,"frillish","轻飘飘"],[594,"alomomola","保姆曼波"],[656,"froakie","呱呱泡蛙"],[692,"clauncher","铁臂枪虾"],[728,"popplio","球球海狮"],[746,"wishiwashi","弱丁鱼"],[751,"dewpider","滴蛛"],[771,"pyukumuku","拳海参"],[779,"bruxish","磨牙彩皮鱼"],[816,"sobble","泪眼蜥"],[833,"chewtle","咬咬龟"],[846,"arrokuda","刺梭鱼"],[882,"dracovish","鳃鱼龙"],[883,"arctovish","鳃鱼海兽"],[912,"quaxly","润水鸭"],[960,"wiglett","海地鼠"],[963,"finizen","波普海豚"],[976,"veluza","轻身鳕"],[977,"dondozo","吃吼霸"]],"Grass":[[1,"bulbasaur","妙蛙种子"],[43,"oddish","走路草"],[69,"bellsprout","喇叭芽"],[102,"exeggcute","蛋蛋"],[114,"tangela","蔓藤怪"],[152,"chikorita","菊草叶"],[187,"hoppip","毽子草"],[191,"sunkern","向日种子"],[252,"treecko","木守宫"],[273,"seedot","橡实果"],[285,"shroomish","蘑蘑菇"],[331,"cacnea","刺球仙人掌"],[357,"tropius","热带龙"],[387,"turtwig","草苗龟"],[406,"budew","含羞苞"],[420,"cherubi","樱花宝"],[455,"carnivine","尖牙笼"],[459,"snover","雪笠怪"],[495,"snivy","藤藤蛇"],[511,"pansage","花椰猴"],[546,"cottonee","木棉球"],[548,"petilil","百合根娃娃"],[556,"maractus","沙铃仙人掌"],[590,"foongus","哎呀球菇"],[597,"ferroseed","种子铁球"],[650,"chespin","哈力栗"],[672,"skiddo","坐骑小羊"],[722,"rowlet","木木枭"],[753,"fomantis","伪螳草"],[755,"morelull","睡睡菇"],[761,"bounsweet","甜竹竹"],[810,"grookey","敲音猴"],[829,"gossifleur","幼棉棉"],[840,"applin","啃果虫"],[906,"sprigatito","新叶喵"],[928,"smoliv","迷你芙"],[946,"bramblin","纳噬草"],[951,"capsakid","热辣娃"],[1012,"poltchageist","斯魔茶"]],"Electric":[[81,"magnemite","小磁怪"],[100,"voltorb","霹雳电球"],[172,"pichu","皮丘"],[179,"mareep","咩利羊"],[239,"elekid","电击怪"],[309,"electrike","落雷兽"],[311,"plusle","正电拍拍"],[312,"minun","負电拍拍"],[403,"shinx","小猫怪"],[417,"pachirisu","帕奇利兹"],[479,"rotom","洛托姆"],[522,"blitzle","斑斑马"],[587,"emolga","电飞鼠"],[602,"tynamo","麻麻小鱼"],[694,"helioptile","伞电蜥"],[702,"dedenne","咚咚鼠"],[777,"togedemaru","托戈德玛尔"],[835,"yamper","来电汪"],[848,"toxel","电音婴"],[871,"pincurchin","啪嚓海胆"],[877,"morpeko","莫鲁贝可"],[880,"dracozolt","雷鸟龙"],[881,"arctozolt","雷鸟海兽"],[921,"pawmi","布拨"],[938,"tadbulb","光蚪仔"],[940,"wattrel","电海燕"]],"Psychic":[[63,"abra","凯西"],[96,"drowzee","催眠貘"],[177,"natu","天然雀"],[201,"unown","未知图腾"],[280,"ralts","拉鲁拉丝"],[325,"spoink","跳跳猪"],[360,"wynaut","小果然"],[433,"chingling","铃铛响"],[439,"mime-jr","魔尼尼"],[517,"munna","食梦梦"],[527,"woobat","滚滚蝙蝠"],[561,"sigilyph","象征鸟"],[574,"gothita","哥德宝宝"],[577,"solosis","单卵细胞球"],[605,"elgyem","小灰怪"],[677,"espurr","妙喵"],[856,"hatenna","迷布莉姆"],[876,"indeedee","爱管侍"],[955,"flittle","飘飘雏"]],"Ice":[[220,"swinub","小山猪"],[225,"delibird","信使鸟"],[238,"smoochum","迷唇娃"],[361,"snorunt","雪童子"],[363,"spheal","海豹球"],[582,"vanillite","迷你冰"],[613,"cubchoo","喷嚏熊"],[615,"cryogonal","几何雪花"],[712,"bergmite","冰宝"],[872,"snom","雪吞虫"],[875,"eiscue","冰砌鹅"],[974,"cetoddle","走鲸"]],"Dragon":[[147,"dratini","迷你龙"],[371,"bagon","宝贝龙"],[443,"gible","圆陆鲨"],[610,"axew","牙牙"],[621,"druddigon","赤面龙"],[704,"goomy","黏黏宝"],[782,"jangmo-o","心鳞宝"],[885,"dreepy","多龙梅西亚"],[967,"cyclizar","摩托蜥"],[978,"tatsugiri","米立龙"],[996,"frigibax","凉脊龙"]],"Dark":[[198,"murkrow","黑暗鸦"],[215,"sneasel","狃拉"],[228,"houndour","戴鲁比"],[261,"poochyena","土狼犬"],[302,"sableye","勾魂眼"],[359,"absol","阿勃梭鲁"],[509,"purrloin","扒手猫"],[559,"scraggy","滑滑小子"],[570,"zorua","索罗亚"],[624,"pawniard","驹刀小兵"],[629,"vullaby","秃鹰丫头"],[633,"deino","单首龙"],[686,"inkay","好啦鱿"],[827,"nickit","狡小狐"],[859,"impidimp","捣蛋小妖"],[942,"maschiff","偶叫獒"]],"Fairy":[[173,"cleffa","皮宝宝"],[175,"togepi","波克比"],[209,"snubbull","布鲁"],[669,"flabebe","花蓓蓓"],[682,"spritzee","粉香香"],[684,"swirlix","绵绵泡芙"],[764,"comfey","花疗环环"],[868,"milcery","小仙奶"],[926,"fidough","狗仔包"],[957,"tinkatink","小锻匠"]]};
const QUESTIONS = [{"id":"Q1","text":"你通常会先行动，再思考后果吗？","yes":{"A1":2},"no":{"A2":2}},{"id":"Q2","text":"在压力下，你会变得更有斗志吗？","yes":{"D1":2},"no":{"D2":2}},{"id":"Q3","text":"做决定时，你更相信直觉而不是分析吗？","yes":{"B1":2},"no":{"B2":2}},{"id":"Q4","text":"你的情绪通常会直接表现在行为和表情上吗？","yes":{"C1":2},"no":{"C2":2}},{"id":"Q5","text":"你是否很在意自己在群体中的位置？","yes":{"E1":2},"no":{"E2":2}},{"id":"Q6","text":"面对未知事物，你会感到兴奋多于不安吗？","yes":{"F1":2},"no":{"F2":2}},{"id":"Q7","text":"你是否很容易被环境或他人影响想法？","yes":{"G1":2},"no":{"G2":2}},{"id":"Q8","text":"如果可以避免冲突，你通常会选择回避？","yes":{"D2":1},"no":{"D1":1}},{"id":"Q9","text":"你更享受当下体验，而非长期规划？","yes":{"A1":1},"no":{"A2":1}},{"id":"Q10","text":"你是否常被他人的情绪所感染？","yes":{"C1":1},"no":{"C2":1}}];
const ARCHETYPE_NAMES = {"A1":"行动爆发型","A2":"持续推进型","B1":"本能反应型","B2":"规则理解型","C1":"情绪外放型","C2":"情绪内收型","D1":"对抗成长型","D2":"回避适应型","E1":"群体依附型","E2":"独立自洽型","F1":"探索好奇型","F2":"稳态保守型","G1":"模仿吸收型","G2":"固化自我型"};
const ARCH_TO_TYPE = {"A1":["Fire","Electric","Flying"],"A2":["Grass","Ground","Steel"],"B1":["Bug","Dragon","Dark"],"B2":["Psychic","Steel","Ice"],"C1":["Fire","Water","Fairy","Normal"],"C2":["Ghost","Poison","Ice"],"D1":["Fighting","Fire","Dragon"],"D2":["Water","Ghost","Ice"],"E1":["Grass","Bug","Fairy"],"E2":["Dragon","Ghost","Rock"],"F1":["Flying","Electric","Water"],"F2":["Ground","Rock","Normal"],"G1":["Normal","Psychic"],"G2":["Steel","Rock"]};

// Evolution / type support (Gen9, no legendary/mythical, no UB/paradox)
const BASE_TO_FINAL_TYPES = {"bulbasaur":["grass","poison"],"charmander":["fire","flying"],"squirtle":["water"],"caterpie":["bug","flying"],"weedle":["bug","poison"],"pidgey":["flying","normal"],"rattata":["normal"],"spearow":["flying","normal"],"ekans":["poison"],"sandshrew":["ground"],"nidoran-f":["ground","poison"],"nidoran-m":["ground","poison"],"vulpix":["fire"],"zubat":["flying","poison"],"oddish":["grass","poison"],"paras":["bug","grass"],"venonat":["bug","poison"],"diglett":["ground"],"meowth":["normal","steel"],"psyduck":["water"],"mankey":["fighting","ghost"],"growlithe":["fire"],"poliwag":["fighting","water"],"abra":["psychic"],"machop":["fighting"],"bellsprout":["grass","poison"],"tentacool":["poison","water"],"geodude":["ground","rock"],"ponyta":["fire"],"slowpoke":["psychic","water"],"magnemite":["electric","steel"],"farfetchd":["fighting","flying","normal"],"doduo":["flying","normal"],"seel":["ice","water"],"grimer":["poison"],"shellder":["ice","water"],"gastly":["ghost","poison"],"onix":["ground","rock","steel"],"drowzee":["psychic"],"krabby":["water"],"voltorb":["electric"],"exeggcute":["grass","psychic"],"cubone":["ground"],"lickitung":["normal"],"koffing":["poison"],"rhyhorn":["ground","rock"],"tangela":["grass"],"kangaskhan":["normal"],"horsea":["dragon","water"],"goldeen":["water"],"staryu":["psychic","water"],"scyther":["bug","flying","rock","steel"],"pinsir":["bug"],"tauros":["normal"],"magikarp":["flying","water"],"lapras":["ice","water"],"ditto":["normal"],"eevee":["dark","electric","fairy","fire","grass","ice","normal","psychic","water"],"porygon":["normal"],"omanyte":["rock","water"],"kabuto":["rock","water"],"aerodactyl":["flying","rock"],"dratini":["dragon","flying"],"chikorita":["grass"],"cyndaquil":["fire"],"totodile":["water"],"sentret":["normal"],"hoothoot":["flying","normal"],"ledyba":["bug","flying"],"spinarak":["bug","poison"],"chinchou":["electric","water"],"pichu":["electric"],"cleffa":["fairy"],"igglybuff":["fairy","normal"],"togepi":["fairy","flying"],"natu":["flying","psychic"],"mareep":["electric"],"hoppip":["flying","grass"],"aipom":["normal"],"sunkern":["grass"],"yanma":["bug","flying"],"wooper":["ground","poison","water"],"murkrow":["dark","flying"],"misdreavus":["ghost"],"unown":["psychic"],"girafarig":["normal","psychic"],"pineco":["bug","steel"],"dunsparce":["normal"],"gligar":["flying","ground"],"snubbull":["fairy"],"qwilfish":["dark","poison","water"],"shuckle":["bug","rock"],"heracross":["bug","fighting"],"sneasel":["dark","fighting","ice","poison"],"teddiursa":["ground","normal"],"slugma":["fire","rock"],"swinub":["ground","ice"],"corsola":["ghost","rock","water"],"remoraid":["water"],"delibird":["flying","ice"],"skarmory":["flying","steel"],"houndour":["dark","fire"],"phanpy":["ground"],"stantler":["normal","psychic"],"smeargle":["normal"],"tyrogue":["fighting"],"smoochum":["ice","psychic"],"elekid":["electric"],"magby":["fire"],"miltank":["normal"],"larvitar":["dark","ground","rock"],"treecko":["grass"],"torchic":["fighting","fire"],"mudkip":["ground","water"],"poochyena":["dark"],"zigzagoon":["dark","normal"],"wurmple":["bug","flying","poison"],"lotad":["grass","water"],"seedot":["dark","grass"],"taillow":["flying","normal"],"wingull":["flying","water"],"ralts":["fairy","fighting","psychic"],"surskit":["bug","flying","water"],"shroomish":["fighting","grass"],"slakoth":["normal"],"nincada":["bug","flying","ghost","ground"],"whismur":["normal"],"makuhita":["fighting"],"azurill":["fairy","normal","water"],"nosepass":["rock","steel"],"skitty":["normal"],"sableye":["dark","ghost"],"mawile":["fairy","steel"],"aron":["rock","steel"],"meditite":["fighting","psychic"],"electrike":["electric"],"plusle":["electric"],"minun":["electric"],"volbeat":["bug"],"illumise":["bug"],"gulpin":["poison"],"carvanha":["dark","water"],"wailmer":["water"],"numel":["fire","ground"],"torkoal":["fire"],"spoink":["psychic"],"spinda":["normal"],"trapinch":["dragon","ground"],"cacnea":["dark","grass"],"swablu":["dragon","flying","normal"],"zangoose":["normal"],"seviper":["poison"],"lunatone":["psychic","rock"],"solrock":["psychic","rock"],"barboach":["ground","water"],"corphish":["dark","water"],"baltoy":["ground","psychic"],"lileep":["grass","rock"],"anorith":["bug","rock"],"feebas":["water"],"castform":["normal"],"kecleon":["normal"],"shuppet":["ghost"],"duskull":["ghost"],"tropius":["flying","grass"],"absol":["dark"],"wynaut":["psychic"],"snorunt":["ghost","ice"],"spheal":["ice","water"],"clamperl":["water"],"relicanth":["rock","water"],"luvdisc":["water"],"bagon":["dragon","flying"],"beldum":["psychic","steel"],"turtwig":["grass","ground"],"chimchar":["fighting","fire"],"piplup":["steel","water"],"starly":["flying","normal"],"bidoof":["normal","water"],"kricketot":["bug"],"shinx":["electric"],"budew":["grass","poison"],"cranidos":["rock"],"shieldon":["rock","steel"],"burmy":["bug","flying","grass"],"combee":["bug","flying"],"pachirisu":["electric"],"buizel":["water"],"cherubi":["grass"],"shellos":["ground","water"],"drifloon":["flying","ghost"],"buneary":["normal"],"glameow":["normal"],"chingling":["psychic"],"stunky":["dark","poison"],"bronzor":["psychic","steel"],"bonsly":["rock"],"mime-jr":["fairy","ice","psychic"],"happiny":["normal"],"chatot":["flying","normal"],"spiritomb":["dark","ghost"],"gible":["dragon","ground"],"munchlax":["normal"],"riolu":["fighting","steel"],"hippopotas":["ground"],"skorupi":["bug","dark","poison"],"croagunk":["fighting","poison"],"carnivine":["grass"],"finneon":["water"],"mantyke":["flying","water"],"snover":["grass","ice"],"rotom":["electric","ghost"],"snivy":["grass"],"tepig":["fighting","fire"],"oshawott":["water"],"patrat":["normal"],"lillipup":["normal"],"purrloin":["dark"],"pansage":["grass"],"pansear":["fire"],"panpour":["water"],"munna":["psychic"],"pidove":["flying","normal"],"blitzle":["electric"],"roggenrola":["rock"],"woobat":["flying","psychic"],"drilbur":["ground","steel"],"audino":["normal"],"timburr":["fighting"],"tympole":["ground","water"],"throh":["fighting"],"sawk":["fighting"],"sewaddle":["bug","grass"],"venipede":["bug","poison"],"cottonee":["fairy","grass"],"petilil":["grass"],"basculin":["ghost","water"],"sandile":["dark","ground"],"darumaka":["fire"],"maractus":["grass"],"dwebble":["bug","rock"],"scraggy":["dark","fighting"],"sigilyph":["flying","psychic"],"yamask":["ghost","ground"],"tirtouga":["rock","water"],"archen":["flying","rock"],"trubbish":["poison"],"zorua":["dark"],"minccino":["normal"],"gothita":["psychic"],"solosis":["psychic"],"ducklett":["flying","water"],"vanillite":["ice"],"deerling":["grass","normal"],"emolga":["electric","flying"],"karrablast":["bug","steel"],"foongus":["grass","poison"],"frillish":["ghost","water"],"alomomola":["water"],"joltik":["bug","electric"],"ferroseed":["grass","steel"],"klink":["steel"],"tynamo":["electric"],"elgyem":["psychic"],"litwick":["fire","ghost"],"axew":["dragon"],"cubchoo":["ice"],"cryogonal":["ice"],"shelmet":["bug"],"stunfisk":["electric","ground"],"mienfoo":["fighting"],"druddigon":["dragon"],"golett":["ghost","ground"],"pawniard":["dark","steel"],"bouffalant":["normal"],"rufflet":["flying","normal"],"vullaby":["dark","flying"],"heatmor":["fire"],"durant":["bug","steel"],"deino":["dark","dragon"],"larvesta":["bug","fire"],"chespin":["fighting","grass"],"fennekin":["fire","psychic"],"froakie":["dark","water"],"bunnelby":["ground","normal"],"fletchling":["fire","flying","normal"],"scatterbug":["bug","flying"],"litleo":["fire","normal"],"flabebe":["fairy"],"skiddo":["grass"],"pancham":["dark","fighting"],"furfrou":["normal"],"espurr":["psychic"],"honedge":["ghost","steel"],"spritzee":["fairy"],"swirlix":["fairy"],"inkay":["dark","psychic"],"binacle":["rock","water"],"skrelp":["dragon","poison","water"],"clauncher":["water"],"helioptile":["electric","normal"],"tyrunt":["dragon","rock"],"amaura":["ice","rock"],"hawlucha":["fighting","flying"],"dedenne":["electric","fairy"],"carbink":["fairy","rock"],"goomy":["dragon"],"klefki":["fairy","steel"],"phantump":["ghost","grass"],"pumpkaboo":["ghost","grass"],"bergmite":["ice"],"noibat":["dragon","flying"],"rowlet":["flying","ghost","grass"],"litten":["dark","fire"],"popplio":["fairy","water"],"pikipek":["flying","normal"],"yungoos":["normal"],"grubbin":["bug","electric"],"crabrawler":["fighting","ice"],"oricorio":["fire","flying"],"cutiefly":["bug","fairy"],"rockruff":["rock"],"wishiwashi":["water"],"mareanie":["poison","water"],"mudbray":["ground"],"dewpider":["bug","water"],"fomantis":["grass"],"morelull":["fairy","grass"],"salandit":["fire","poison"],"stufful":["fighting","normal"],"bounsweet":["grass"],"comfey":["fairy"],"oranguru":["normal","psychic"],"passimian":["fighting"],"wimpod":["bug","water"],"sandygast":["ghost","ground"],"pyukumuku":["water"],"minior":["flying","rock"],"komala":["normal"],"turtonator":["dragon","fire"],"togedemaru":["electric","steel"],"mimikyu":["fairy","ghost"],"bruxish":["psychic","water"],"drampa":["dragon","normal"],"dhelmise":["ghost","grass"],"jangmo-o":["dragon","fighting"],"grookey":["grass"],"scorbunny":["fire"],"sobble":["water"],"skwovet":["normal"],"rookidee":["flying","steel"],"blipbug":["bug","psychic"],"nickit":["dark"],"gossifleur":["grass"],"wooloo":["normal"],"chewtle":["rock","water"],"yamper":["electric"],"rolycoly":["fire","rock"],"applin":["dragon","grass"],"silicobra":["ground"],"cramorant":["flying","water"],"arrokuda":["water"],"toxel":["electric","poison"],"sizzlipede":["bug","fire"],"clobbopus":["fighting"],"sinistea":["ghost"],"hatenna":["fairy","psychic"],"impidimp":["dark","fairy"],"milcery":["fairy"],"falinks":["fighting"],"pincurchin":["electric"],"snom":["bug","ice"],"stonjourner":["rock"],"eiscue":["ice"],"indeedee":["normal","psychic"],"morpeko":["dark","electric"],"cufant":["steel"],"dracozolt":["dragon","electric"],"arctozolt":["electric","ice"],"dracovish":["dragon","water"],"arctovish":["ice","water"],"duraludon":["dragon","steel"],"dreepy":["dragon","ghost"],"sprigatito":["dark","grass"],"fuecoco":["fire","ghost"],"quaxly":["fighting","water"],"lechonk":["normal"],"tarountula":["bug"],"nymble":["bug","dark"],"pawmi":["electric","fighting"],"tandemaus":["normal"],"fidough":["fairy"],"smoliv":["grass","normal"],"squawkabilly":["flying","normal"],"nacli":["rock"],"charcadet":["fire","ghost","psychic"],"tadbulb":["electric"],"wattrel":["electric","flying"],"maschiff":["dark"],"shroodle":["normal","poison"],"bramblin":["ghost","grass"],"toedscool":["grass","ground"],"klawf":["rock"],"capsakid":["fire","grass"],"rellor":["bug","psychic"],"flittle":["psychic"],"tinkatink":["fairy","steel"],"wiglett":["water"],"bombirdier":["dark","flying"],"finizen":["water"],"varoom":["poison","steel"],"cyclizar":["dragon","normal"],"orthworm":["steel"],"glimmet":["poison","rock"],"greavard":["ghost"],"flamigo":["fighting","flying"],"cetoddle":["ice"],"veluza":["psychic","water"],"dondozo":["water"],"tatsugiri":["dragon","water"],"frigibax":["dragon","ice"],"gimmighoul":["ghost","steel"],"poltchageist":["ghost","grass"]};   // base identifier -> [typeNameLower...], union of leaf-stage types
const BASE_TO_BASE_TYPES  = {"bulbasaur":["grass","poison"],"charmander":["fire"],"squirtle":["water"],"caterpie":["bug"],"weedle":["bug","poison"],"pidgey":["normal","flying"],"rattata":["normal"],"spearow":["normal","flying"],"ekans":["poison"],"sandshrew":["ground"],"nidoran-f":["poison"],"nidoran-m":["poison"],"vulpix":["fire"],"zubat":["poison","flying"],"oddish":["grass","poison"],"paras":["bug","grass"],"venonat":["bug","poison"],"diglett":["ground"],"meowth":["normal"],"psyduck":["water"],"mankey":["fighting"],"growlithe":["fire"],"poliwag":["water"],"abra":["psychic"],"machop":["fighting"],"bellsprout":["grass","poison"],"tentacool":["water","poison"],"geodude":["rock","ground"],"ponyta":["fire"],"slowpoke":["water","psychic"],"magnemite":["electric","steel"],"farfetchd":["normal","flying"],"doduo":["normal","flying"],"seel":["water"],"grimer":["poison"],"shellder":["water"],"gastly":["ghost","poison"],"onix":["rock","ground"],"drowzee":["psychic"],"krabby":["water"],"voltorb":["electric"],"exeggcute":["grass","psychic"],"cubone":["ground"],"lickitung":["normal"],"koffing":["poison"],"rhyhorn":["ground","rock"],"tangela":["grass"],"kangaskhan":["normal"],"horsea":["water"],"goldeen":["water"],"staryu":["water"],"scyther":["bug","flying"],"pinsir":["bug"],"tauros":["normal"],"magikarp":["water"],"lapras":["water","ice"],"ditto":["normal"],"eevee":["normal"],"porygon":["normal"],"omanyte":["rock","water"],"kabuto":["rock","water"],"aerodactyl":["rock","flying"],"dratini":["dragon"],"chikorita":["grass"],"cyndaquil":["fire"],"totodile":["water"],"sentret":["normal"],"hoothoot":["normal","flying"],"ledyba":["bug","flying"],"spinarak":["bug","poison"],"chinchou":["water","electric"],"pichu":["electric"],"cleffa":["fairy"],"igglybuff":["normal","fairy"],"togepi":["fairy"],"natu":["psychic","flying"],"mareep":["electric"],"hoppip":["grass","flying"],"aipom":["normal"],"sunkern":["grass"],"yanma":["bug","flying"],"wooper":["water","ground"],"murkrow":["dark","flying"],"misdreavus":["ghost"],"unown":["psychic"],"girafarig":["normal","psychic"],"pineco":["bug"],"dunsparce":["normal"],"gligar":["ground","flying"],"snubbull":["fairy"],"qwilfish":["water","poison"],"shuckle":["bug","rock"],"heracross":["bug","fighting"],"sneasel":["dark","ice"],"teddiursa":["normal"],"slugma":["fire"],"swinub":["ice","ground"],"corsola":["water","rock"],"remoraid":["water"],"delibird":["ice","flying"],"skarmory":["steel","flying"],"houndour":["dark","fire"],"phanpy":["ground"],"stantler":["normal"],"smeargle":["normal"],"tyrogue":["fighting"],"smoochum":["ice","psychic"],"elekid":["electric"],"magby":["fire"],"miltank":["normal"],"larvitar":["rock","ground"],"treecko":["grass"],"torchic":["fire"],"mudkip":["water"],"poochyena":["dark"],"zigzagoon":["normal"],"wurmple":["bug"],"lotad":["water","grass"],"seedot":["grass"],"taillow":["normal","flying"],"wingull":["water","flying"],"ralts":["psychic","fairy"],"surskit":["bug","water"],"shroomish":["grass"],"slakoth":["normal"],"nincada":["bug","ground"],"whismur":["normal"],"makuhita":["fighting"],"azurill":["normal","fairy"],"nosepass":["rock"],"skitty":["normal"],"sableye":["dark","ghost"],"mawile":["steel","fairy"],"aron":["steel","rock"],"meditite":["fighting","psychic"],"electrike":["electric"],"plusle":["electric"],"minun":["electric"],"volbeat":["bug"],"illumise":["bug"],"gulpin":["poison"],"carvanha":["water","dark"],"wailmer":["water"],"numel":["fire","ground"],"torkoal":["fire"],"spoink":["psychic"],"spinda":["normal"],"trapinch":["ground"],"cacnea":["grass"],"swablu":["normal","flying"],"zangoose":["normal"],"seviper":["poison"],"lunatone":["rock","psychic"],"solrock":["rock","psychic"],"barboach":["water","ground"],"corphish":["water"],"baltoy":["ground","psychic"],"lileep":["rock","grass"],"anorith":["rock","bug"],"feebas":["water"],"castform":["normal"],"kecleon":["normal"],"shuppet":["ghost"],"duskull":["ghost"],"tropius":["grass","flying"],"absol":["dark"],"wynaut":["psychic"],"snorunt":["ice"],"spheal":["ice","water"],"clamperl":["water"],"relicanth":["water","rock"],"luvdisc":["water"],"bagon":["dragon"],"beldum":["steel","psychic"],"turtwig":["grass"],"chimchar":["fire"],"piplup":["water"],"starly":["normal","flying"],"bidoof":["normal"],"kricketot":["bug"],"shinx":["electric"],"budew":["grass","poison"],"cranidos":["rock"],"shieldon":["rock","steel"],"burmy":["bug"],"combee":["bug","flying"],"pachirisu":["electric"],"buizel":["water"],"cherubi":["grass"],"shellos":["water"],"drifloon":["ghost","flying"],"buneary":["normal"],"glameow":["normal"],"chingling":["psychic"],"stunky":["poison","dark"],"bronzor":["steel","psychic"],"bonsly":["rock"],"mime-jr":["psychic","fairy"],"happiny":["normal"],"chatot":["normal","flying"],"spiritomb":["ghost","dark"],"gible":["dragon","ground"],"munchlax":["normal"],"riolu":["fighting"],"hippopotas":["ground"],"skorupi":["poison","bug"],"croagunk":["poison","fighting"],"carnivine":["grass"],"finneon":["water"],"mantyke":["water","flying"],"snover":["grass","ice"],"rotom":["electric","ghost"],"snivy":["grass"],"tepig":["fire"],"oshawott":["water"],"patrat":["normal"],"lillipup":["normal"],"purrloin":["dark"],"pansage":["grass"],"pansear":["fire"],"panpour":["water"],"munna":["psychic"],"pidove":["normal","flying"],"blitzle":["electric"],"roggenrola":["rock"],"woobat":["psychic","flying"],"drilbur":["ground"],"audino":["normal"],"timburr":["fighting"],"tympole":["water"],"throh":["fighting"],"sawk":["fighting"],"sewaddle":["bug","grass"],"venipede":["bug","poison"],"cottonee":["grass","fairy"],"petilil":["grass"],"basculin":["water"],"sandile":["ground","dark"],"darumaka":["fire"],"maractus":["grass"],"dwebble":["bug","rock"],"scraggy":["dark","fighting"],"sigilyph":["psychic","flying"],"yamask":["ghost"],"tirtouga":["water","rock"],"archen":["rock","flying"],"trubbish":["poison"],"zorua":["dark"],"minccino":["normal"],"gothita":["psychic"],"solosis":["psychic"],"ducklett":["water","flying"],"vanillite":["ice"],"deerling":["normal","grass"],"emolga":["electric","flying"],"karrablast":["bug"],"foongus":["grass","poison"],"frillish":["water","ghost"],"alomomola":["water"],"joltik":["bug","electric"],"ferroseed":["grass","steel"],"klink":["steel"],"tynamo":["electric"],"elgyem":["psychic"],"litwick":["ghost","fire"],"axew":["dragon"],"cubchoo":["ice"],"cryogonal":["ice"],"shelmet":["bug"],"stunfisk":["ground","electric"],"mienfoo":["fighting"],"druddigon":["dragon"],"golett":["ground","ghost"],"pawniard":["dark","steel"],"bouffalant":["normal"],"rufflet":["normal","flying"],"vullaby":["dark","flying"],"heatmor":["fire"],"durant":["bug","steel"],"deino":["dark","dragon"],"larvesta":["bug","fire"],"chespin":["grass"],"fennekin":["fire"],"froakie":["water"],"bunnelby":["normal"],"fletchling":["normal","flying"],"scatterbug":["bug"],"litleo":["fire","normal"],"flabebe":["fairy"],"skiddo":["grass"],"pancham":["fighting"],"furfrou":["normal"],"espurr":["psychic"],"honedge":["steel","ghost"],"spritzee":["fairy"],"swirlix":["fairy"],"inkay":["dark","psychic"],"binacle":["rock","water"],"skrelp":["poison","water"],"clauncher":["water"],"helioptile":["electric","normal"],"tyrunt":["rock","dragon"],"amaura":["rock","ice"],"hawlucha":["fighting","flying"],"dedenne":["electric","fairy"],"carbink":["rock","fairy"],"goomy":["dragon"],"klefki":["steel","fairy"],"phantump":["ghost","grass"],"pumpkaboo":["ghost","grass"],"bergmite":["ice"],"noibat":["flying","dragon"],"rowlet":["grass","flying"],"litten":["fire"],"popplio":["water"],"pikipek":["normal","flying"],"yungoos":["normal"],"grubbin":["bug"],"crabrawler":["fighting"],"oricorio":["fire","flying"],"cutiefly":["bug","fairy"],"rockruff":["rock"],"wishiwashi":["water"],"mareanie":["poison","water"],"mudbray":["ground"],"dewpider":["water","bug"],"fomantis":["grass"],"morelull":["grass","fairy"],"salandit":["poison","fire"],"stufful":["normal","fighting"],"bounsweet":["grass"],"comfey":["fairy"],"oranguru":["normal","psychic"],"passimian":["fighting"],"wimpod":["bug","water"],"sandygast":["ghost","ground"],"pyukumuku":["water"],"minior":["rock","flying"],"komala":["normal"],"turtonator":["fire","dragon"],"togedemaru":["electric","steel"],"mimikyu":["ghost","fairy"],"bruxish":["water","psychic"],"drampa":["normal","dragon"],"dhelmise":["ghost","grass"],"jangmo-o":["dragon"],"grookey":["grass"],"scorbunny":["fire"],"sobble":["water"],"skwovet":["normal"],"rookidee":["flying"],"blipbug":["bug"],"nickit":["dark"],"gossifleur":["grass"],"wooloo":["normal"],"chewtle":["water"],"yamper":["electric"],"rolycoly":["rock"],"applin":["grass","dragon"],"silicobra":["ground"],"cramorant":["flying","water"],"arrokuda":["water"],"toxel":["electric","poison"],"sizzlipede":["fire","bug"],"clobbopus":["fighting"],"sinistea":["ghost"],"hatenna":["psychic"],"impidimp":["dark","fairy"],"milcery":["fairy"],"falinks":["fighting"],"pincurchin":["electric"],"snom":["ice","bug"],"stonjourner":["rock"],"eiscue":["ice"],"indeedee":["psychic","normal"],"morpeko":["electric","dark"],"cufant":["steel"],"dracozolt":["electric","dragon"],"arctozolt":["electric","ice"],"dracovish":["water","dragon"],"arctovish":["water","ice"],"duraludon":["steel","dragon"],"dreepy":["dragon","ghost"],"sprigatito":["grass"],"fuecoco":["fire"],"quaxly":["water"],"lechonk":["normal"],"tarountula":["bug"],"nymble":["bug"],"pawmi":["electric"],"tandemaus":["normal"],"fidough":["fairy"],"smoliv":["grass","normal"],"squawkabilly":["normal","flying"],"nacli":["rock"],"charcadet":["fire"],"tadbulb":["electric"],"wattrel":["electric","flying"],"maschiff":["dark"],"shroodle":["poison","normal"],"bramblin":["grass","ghost"],"toedscool":["ground","grass"],"klawf":["rock"],"capsakid":["grass"],"rellor":["bug"],"flittle":["psychic"],"tinkatink":["fairy","steel"],"wiglett":["water"],"bombirdier":["flying","dark"],"finizen":["water"],"varoom":["steel","poison"],"cyclizar":["dragon","normal"],"orthworm":["steel"],"glimmet":["rock","poison"],"greavard":["ghost"],"flamigo":["flying","fighting"],"cetoddle":["ice"],"veluza":["water","psychic"],"dondozo":["water"],"tatsugiri":["dragon","water"],"frigibax":["dragon","ice"],"gimmighoul":["ghost"],"poltchageist":["grass","ghost"]};    // base identifier -> [typeNameLower...], base's own types (for pure-mode)
const BASE_IS_MONO        = {"bulbasaur":false,"charmander":true,"squirtle":true,"caterpie":true,"weedle":false,"pidgey":false,"rattata":true,"spearow":false,"ekans":true,"sandshrew":true,"nidoran-f":true,"nidoran-m":true,"vulpix":true,"zubat":false,"oddish":false,"paras":false,"venonat":false,"diglett":true,"meowth":true,"psyduck":true,"mankey":true,"growlithe":true,"poliwag":true,"abra":true,"machop":true,"bellsprout":false,"tentacool":false,"geodude":false,"ponyta":true,"slowpoke":false,"magnemite":false,"farfetchd":false,"doduo":false,"seel":true,"grimer":true,"shellder":true,"gastly":false,"onix":false,"drowzee":true,"krabby":true,"voltorb":true,"exeggcute":false,"cubone":true,"lickitung":true,"koffing":true,"rhyhorn":false,"tangela":true,"kangaskhan":true,"horsea":true,"goldeen":true,"staryu":true,"scyther":false,"pinsir":true,"tauros":true,"magikarp":true,"lapras":false,"ditto":true,"eevee":true,"porygon":true,"omanyte":false,"kabuto":false,"aerodactyl":false,"dratini":true,"chikorita":true,"cyndaquil":true,"totodile":true,"sentret":true,"hoothoot":false,"ledyba":false,"spinarak":false,"chinchou":false,"pichu":true,"cleffa":true,"igglybuff":false,"togepi":true,"natu":false,"mareep":true,"hoppip":false,"aipom":true,"sunkern":true,"yanma":false,"wooper":false,"murkrow":false,"misdreavus":true,"unown":true,"girafarig":false,"pineco":true,"dunsparce":true,"gligar":false,"snubbull":true,"qwilfish":false,"shuckle":false,"heracross":false,"sneasel":false,"teddiursa":true,"slugma":true,"swinub":false,"corsola":false,"remoraid":true,"delibird":false,"skarmory":false,"houndour":false,"phanpy":true,"stantler":true,"smeargle":true,"tyrogue":true,"smoochum":false,"elekid":true,"magby":true,"miltank":true,"larvitar":false,"treecko":true,"torchic":true,"mudkip":true,"poochyena":true,"zigzagoon":true,"wurmple":true,"lotad":false,"seedot":true,"taillow":false,"wingull":false,"ralts":false,"surskit":false,"shroomish":true,"slakoth":true,"nincada":false,"whismur":true,"makuhita":true,"azurill":false,"nosepass":true,"skitty":true,"sableye":false,"mawile":false,"aron":false,"meditite":false,"electrike":true,"plusle":true,"minun":true,"volbeat":true,"illumise":true,"gulpin":true,"carvanha":false,"wailmer":true,"numel":false,"torkoal":true,"spoink":true,"spinda":true,"trapinch":true,"cacnea":true,"swablu":false,"zangoose":true,"seviper":true,"lunatone":false,"solrock":false,"barboach":false,"corphish":true,"baltoy":false,"lileep":false,"anorith":false,"feebas":true,"castform":true,"kecleon":true,"shuppet":true,"duskull":true,"tropius":false,"absol":true,"wynaut":true,"snorunt":true,"spheal":false,"clamperl":true,"relicanth":false,"luvdisc":true,"bagon":true,"beldum":false,"turtwig":true,"chimchar":true,"piplup":true,"starly":false,"bidoof":true,"kricketot":true,"shinx":true,"budew":false,"cranidos":true,"shieldon":false,"burmy":true,"combee":false,"pachirisu":true,"buizel":true,"cherubi":true,"shellos":true,"drifloon":false,"buneary":true,"glameow":true,"chingling":true,"stunky":false,"bronzor":false,"bonsly":true,"mime-jr":false,"happiny":true,"chatot":false,"spiritomb":false,"gible":false,"munchlax":true,"riolu":true,"hippopotas":true,"skorupi":false,"croagunk":false,"carnivine":true,"finneon":true,"mantyke":false,"snover":false,"rotom":false,"snivy":true,"tepig":true,"oshawott":true,"patrat":true,"lillipup":true,"purrloin":true,"pansage":true,"pansear":true,"panpour":true,"munna":true,"pidove":false,"blitzle":true,"roggenrola":true,"woobat":false,"drilbur":true,"audino":true,"timburr":true,"tympole":true,"throh":true,"sawk":true,"sewaddle":false,"venipede":false,"cottonee":false,"petilil":true,"basculin":true,"sandile":false,"darumaka":true,"maractus":true,"dwebble":false,"scraggy":false,"sigilyph":false,"yamask":true,"tirtouga":false,"archen":false,"trubbish":true,"zorua":true,"minccino":true,"gothita":true,"solosis":true,"ducklett":false,"vanillite":true,"deerling":false,"emolga":false,"karrablast":true,"foongus":false,"frillish":false,"alomomola":true,"joltik":false,"ferroseed":false,"klink":true,"tynamo":true,"elgyem":true,"litwick":false,"axew":true,"cubchoo":true,"cryogonal":true,"shelmet":true,"stunfisk":false,"mienfoo":true,"druddigon":true,"golett":false,"pawniard":false,"bouffalant":true,"rufflet":false,"vullaby":false,"heatmor":true,"durant":false,"deino":false,"larvesta":false,"chespin":true,"fennekin":true,"froakie":true,"bunnelby":true,"fletchling":false,"scatterbug":true,"litleo":false,"flabebe":true,"skiddo":true,"pancham":true,"furfrou":true,"espurr":true,"honedge":false,"spritzee":true,"swirlix":true,"inkay":false,"binacle":false,"skrelp":false,"clauncher":true,"helioptile":false,"tyrunt":false,"amaura":false,"hawlucha":false,"dedenne":false,"carbink":false,"goomy":true,"klefki":false,"phantump":false,"pumpkaboo":false,"bergmite":true,"noibat":false,"rowlet":false,"litten":true,"popplio":true,"pikipek":false,"yungoos":true,"grubbin":true,"crabrawler":true,"oricorio":false,"cutiefly":false,"rockruff":true,"wishiwashi":true,"mareanie":false,"mudbray":true,"dewpider":false,"fomantis":true,"morelull":false,"salandit":false,"stufful":false,"bounsweet":true,"comfey":true,"oranguru":false,"passimian":true,"wimpod":false,"sandygast":false,"pyukumuku":true,"minior":false,"komala":true,"turtonator":false,"togedemaru":false,"mimikyu":false,"bruxish":false,"drampa":false,"dhelmise":false,"jangmo-o":true,"grookey":true,"scorbunny":true,"sobble":true,"skwovet":true,"rookidee":true,"blipbug":true,"nickit":true,"gossifleur":true,"wooloo":true,"chewtle":true,"yamper":true,"rolycoly":true,"applin":false,"silicobra":true,"cramorant":false,"arrokuda":true,"toxel":false,"sizzlipede":false,"clobbopus":true,"sinistea":true,"hatenna":true,"impidimp":false,"milcery":true,"falinks":true,"pincurchin":true,"snom":false,"stonjourner":true,"eiscue":true,"indeedee":false,"morpeko":false,"cufant":true,"dracozolt":false,"arctozolt":false,"dracovish":false,"arctovish":false,"duraludon":false,"dreepy":false,"sprigatito":true,"fuecoco":true,"quaxly":true,"lechonk":true,"tarountula":true,"nymble":true,"pawmi":true,"tandemaus":true,"fidough":true,"smoliv":false,"squawkabilly":false,"nacli":true,"charcadet":true,"tadbulb":true,"wattrel":false,"maschiff":true,"shroodle":false,"bramblin":false,"toedscool":false,"klawf":true,"capsakid":true,"rellor":true,"flittle":true,"tinkatink":false,"wiglett":true,"bombirdier":false,"finizen":true,"varoom":false,"cyclizar":false,"orthworm":true,"glimmet":false,"greavard":true,"flamigo":false,"cetoddle":true,"veluza":false,"dondozo":true,"tatsugiri":false,"frigibax":false,"gimmighoul":true,"poltchageist":false};    // base identifier -> boolean (base itself mono-type)

// Wuxing stem/branch maps
const STEM_TO_WUXING = {
  "甲":"Wood","乙":"Wood","丙":"Fire","丁":"Fire","戊":"Earth","己":"Earth","庚":"Metal","辛":"Metal","壬":"Water","癸":"Water"
};
const BRANCH_TO_WUXING = {
  "子":"Water","丑":"Earth","寅":"Wood","卯":"Wood","辰":"Earth","巳":"Fire","午":"Fire","未":"Earth","申":"Metal","酉":"Metal","戌":"Earth","亥":"Water"
};

function toTitle(tLower) {
  if (!tLower) return tLower;
  return tLower.charAt(0).toUpperCase() + tLower.slice(1);
}

function poolStats() {
  const entries = Object.entries(POOLS).map(([k,v])=>[k,v.length]).sort((a,b)=>b[1]-a[1]);
  const total = entries.reduce((s,[_k,n])=>s+n,0);
  const lines = [
    `总可抽取初始形态：<strong>${total}</strong>（已移除传说/幻/究极异兽/悖论）`,
    `覆盖属性：<strong>${entries.length}</strong>`,
    '',
    ...entries.map(([k,n])=>`${k}（${CONFIG.type_zh[k]||k}）：${n}`)
  ];
  document.getElementById("poolStats").innerHTML = lines.join("<br/>");
}

function renderQuiz() {
  const root = document.getElementById("quiz");
  root.innerHTML = "";
  QUESTIONS.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "q";
    div.innerHTML = `
      <div class="qhead">
        <div class="qid">${q.id}</div>
        <div class="btns">
          <button data-q="${idx}" data-a="yes">是</button>
          <button data-q="${idx}" data-a="no">否</button>
        </div>
      </div>
      <div class="qtext">${q.text}</div>
    `;
    root.appendChild(div);
  });

  root.addEventListener("click", (e) => {
    if (e.target.tagName !== "BUTTON") return;
    const idx = Number(e.target.getAttribute("data-q"));
    const a = e.target.getAttribute("data-a");
    const qDiv = root.children[idx];
    const buttons = qDiv.querySelectorAll("button");
    buttons.forEach(b=>b.classList.remove("sel-yes","sel-no"));
    if (a === "yes") buttons[0].classList.add("sel-yes");
    else buttons[1].classList.add("sel-no");
    qDiv.setAttribute("data-answer", a);
    document.getElementById("msg").textContent = "";
  });
}

function getAnswers() {
  const root = document.getElementById("quiz");
  const ans = [];
  for (let i=0;i<QUESTIONS.length;i++) {
    const a = root.children[i].getAttribute("data-answer");
    if (!a) return null;
    ans.push(a === "yes");
  }
  return ans;
}

function bitstring(answers) { return answers.map(a=>a?"1":"0").join(""); }

function fnv1a(str) {
  let h = 0x811c9dc5;
  for (let i=0;i<str.length;i++) {
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24))) >>> 0;
  }
  return h >>> 0;
}

function normalize(scores) {
  const vals = Object.values(scores);
  const max = Math.max(...vals, 1e-9);
  const out = {};
  Object.entries(scores).forEach(([k,v])=>out[k]=v/max);
  return out;
}

function topN(score, n=2) {
  return Object.entries(score).sort((a,b)=>b[1]-a[1]).slice(0,n);
}

function argmax(scoreObj, allowSet=null) {
  let bestK = null, bestV = -Infinity;
  for (const [k,v] of Object.entries(scoreObj)) {
    if (allowSet && !allowSet.has(k)) continue;
    if (v > bestV) { bestV = v; bestK = k; }
  }
  return bestK;
}

function scoreArchetypes(answers) {
  const score = {};
  Object.keys(ARCHETYPE_NAMES).forEach(k=>score[k]=0);
  QUESTIONS.forEach((q, i) => {
    const delta = answers[i] ? q.yes : q.no;
    Object.entries(delta).forEach(([k,v])=>score[k]=(score[k]||0)+v);
  });
  return score;
}

function projectArchetypeToTypes(archScore) {
  const typeScore = {};
  Object.keys(CONFIG.type_zh).forEach(t=>typeScore[t]=0);
  for (const [arch, s] of Object.entries(archScore)) {
    (ARCH_TO_TYPE[arch]||[]).forEach(t => {
      typeScore[t] = (typeScore[t]||0) + s;
    });
  }
  return typeScore;
}

function getBazi() {
  const d = document.getElementById("birthDate").value;
  if (!d) return null;
  const t = document.getElementById("birthTime").value || "12:00";
  const [Y,M,D] = d.split("-").map(x=>parseInt(x,10));
  const [hh,mm] = t.split(":").map(x=>parseInt(x,10));
  if (typeof Solar === "undefined") return { error: "八字库未加载（可能被网络拦截）" };
  try {
    const solar = Solar.fromYmdHms ? Solar.fromYmdHms(Y, M, D, hh, mm, 0) : Solar.fromYmd(Y, M, D);
    const lunar = solar.getLunar();
    const bazi = lunar.getBaZi ? lunar.getBaZi() : null;
    if (!bazi || !Array.isArray(bazi) || bazi.length < 4) return { error: "八字接口不可用（库版本差异）" };
    return { bazi };
  } catch (e) {
    return { error: "八字计算失败：" + (e && e.message ? e.message : String(e)) };
  }
}

function wuxingFromBaziWithWeights(bazi, weights) {
  const score = {Wood:0,Fire:0,Earth:0,Metal:0,Water:0};
  bazi.forEach((gz, i) => {
    const w = weights[i] || 1.0;
    const stem = gz[0];
    const branch = gz[1];
    const se = STEM_TO_WUXING[stem];
    const be = BRANCH_TO_WUXING[branch];
    if (se) score[se] += 1.0 * w;
    if (be) score[be] += 0.6 * w;
  });
  return score;
}

function dayPillarWuxing(bazi) {
  if (!bazi || bazi.length < 3) return null;
  const gz = bazi[2]; // 日柱
  const stem = gz[0], branch = gz[1];
  return STEM_TO_WUXING[stem] || BRANCH_TO_WUXING[branch] || null;
}

function baziPriorArchetype(wuxingScore) {
  const prior = {};
  Object.keys(ARCHETYPE_NAMES).forEach(k=>prior[k]=0);
  for (const [wx, wxScore] of Object.entries(wuxingScore)) {
    const map = CONFIG.wuxing_to_archetype_prior[wx];
    if (!map) continue;
    for (const [arch, w] of Object.entries(map)) {
      prior[arch] += wxScore * w;
    }
  }
  return prior;
}

function baziTypeBias(wuxingScore) {
  const bias = {};
  for (const t of Object.keys(CONFIG.type_zh)) {
    const wx = CONFIG.type_to_wuxing[t];
    bias[t] = wx ? (wuxingScore[wx] || 0) : 0;
  }
  return bias;
}

function blendFinalType(quizArchScore, baziPrior, baziBias) {
  const finalArch = {};
  for (const k of Object.keys(ARCHETYPE_NAMES)) {
    finalArch[k] = CONFIG.alpha * (quizArchScore[k]||0) + (1-CONFIG.alpha) * (baziPrior ? (baziPrior[k]||0) : 0);
  }
  const typeFromArch = projectArchetypeToTypes(finalArch);
  const a = normalize(typeFromArch);
  const b = baziBias ? normalize(baziBias) : null;
  const finalTypeScore = {};
  for (const t of Object.keys(CONFIG.type_zh)) {
    finalTypeScore[t] = (1-CONFIG.beta) * (a[t]||0) + (CONFIG.beta) * (b ? (b[t]||0) : 0);
  }
  return { finalTypeScore, finalArch };
}

function allowedTypesByWuxing(wx) {
  if (!wx) return new Set(Object.keys(CONFIG.type_zh));
  const allowed = new Set();
  for (const t of Object.keys(CONFIG.type_zh)) {
    if (CONFIG.type_to_wuxing[t] === wx) allowed.add(t);
  }
  return allowed;
}

function dominantWuxing(wuxingScore) {
  if (!wuxingScore) return null;
  return argmax(wuxingScore);
}

function pickFromTopN(scoredTopN, seed) {
  if (!scoredTopN.length) return null;
  const h = fnv1a(seed);
  return scoredTopN[h % scoredTopN.length];
}

function renderBars(scoreObj, top=6) {
  const arr = Object.entries(scoreObj).sort((a,b)=>b[1]-a[1]).slice(0,top);
  const max = arr[0]?.[1] || 1;
  return arr.map(([k,v])=>{
    const pct = Math.round((v/max)*100);
    return `
      <div style="margin:10px 0 8px;">
        <div class="small"><strong>${CONFIG.type_zh[k]}（${k}）</strong> <span class="mono">=${v.toFixed(2)}</span></div>
        <div class="bar"><div style="width:${pct}%"></div></div>
      </div>
    `;
  }).join("");
}

function renderWuxing(wuxingScore) {
  if (!wuxingScore) return "";
  const arr = Object.entries(wuxingScore).sort((a,b)=>b[1]-a[1]);
  const max = arr[0]?.[1] || 1;
  return arr.map(([k,v])=>{
    const pct = Math.round((v/max)*100);
    return `
      <div style="margin:10px 0 8px;">
        <div class="small"><strong>${CONFIG.wuxing_zh[k]}（${k}）</strong> <span class="mono">=${v.toFixed(2)}</span></div>
        <div class="bar"><div style="width:${pct}%"></div></div>
      </div>
    `;
  }).join("");
}

function scoreAndRankCandidates(primaryType, secondaryFixedTitle, top1, top2k, domWx, wantedArc, mode) {
  // mode: "dual" or "pure"
  const pool = POOLS[primaryType] || [];
  const tagsDefault = CONFIG.type_to_default_archetype_tags[primaryType] || [];
  const typeWx = CONFIG.type_to_wuxing[primaryType] || null;

  const secFixedLower = secondaryFixedTitle ? secondaryFixedTitle.toLowerCase() : null;

  const scored = [];
  for (let idx=0; idx<pool.length; idx++) {
    const [pid, identifier, zh] = pool[idx];

    // ===== Hard constraints first =====
    if (mode === "pure") {
      // pure mode: base itself must be mono-type and equal to primaryType
      if (!BASE_IS_MONO[identifier]) continue;
      const bt = BASE_TO_BASE_TYPES[identifier] || [];
      if (bt.length !== 1) continue;
      if (toTitle(bt[0]) !== primaryType) continue;
    } else {
      // dual mode: do NOT change secondary; only accept candidates whose evolution chain can reach secondaryFixed
      if (!secFixedLower) continue;
      const finalSetLower = BASE_TO_FINAL_TYPES[identifier] || [];
      if (!finalSetLower.includes(secFixedLower)) continue;
    }

    // ===== Soft scoring (ranking) =====
    const arcH = fnv1a(identifier + "|" + String(pid||"") + "|" + primaryType);
    const arc = ["burst_leap","stable_accumulate","condition_trigger"][arcH % 3];

    let s = 0;
    const why = [];

    if (domWx && typeWx === domWx) { s += 2; why.push(`命格底色：${CONFIG.wuxing_zh[domWx]}（气质一致）`); }
    if (top1 && tagsDefault.includes(top1)) { s += 2; why.push(`行为命中：Top1=${ARCHETYPE_NAMES[top1]}`); }
    if (top2k && tagsDefault.includes(top2k)) { s += 1; why.push(`行为命中：Top2=${ARCHETYPE_NAMES[top2k]}`); }
    if (wantedArc && arc === wantedArc) { s += 1; why.push(`成长节奏：${arc}`); }

    if (mode === "dual") {
      s += 3; // guaranteed match for secondary by constraint, reward it
      why.push(`副属性命中：${CONFIG.type_zh[secondaryFixedTitle]}（进化链可达）`);
    } else {
      why.push(`纯属性模式：初始形态单属性且主副同源`);
    }

    scored.push({ idx, pid, identifier, zh, arc, s, why });
  }

  scored.sort((a,b)=>b.s-a.s || a.idx-b.idx);
  return scored;
}

document.getElementById("calcBtn")).addEventListener("click", () => {
  const ans = getAnswers();
  if (!ans) {
    document.getElementById("msg").textContent = "还差几题没选完：请把 10 题都选上再生成结果。";
    return;
  }

  const quizArchScore = scoreArchetypes(ans);
  const top2 = topN(quizArchScore, 2);
  const top1 = top2[0]?.[0] || null;
  const top2k = top2[1]?.[0] || null;

  const baziInfo = getBazi();
  let wuxingScore = null, baziPrior = null, baziBias = null;
  let baziStr = "no-bazi";
  let dayWx = null;

  if (baziInfo) {
    if (baziInfo.error) {
      document.getElementById("msg").textContent = baziInfo.error;
      return;
    }
    // full weights: emphasize day pillar (your preference)
    const weightsMain = [0.9, 1.4, 1.8, 1.0];
    wuxingScore = wuxingFromBaziWithWeights(baziInfo.bazi, weightsMain);
    baziPrior = baziPriorArchetype(wuxingScore);
    baziBias = baziTypeBias(wuxingScore);
    baziStr = baziInfo.bazi.join("");
    dayWx = dayPillarWuxing(baziInfo.bazi);
  }

  // 1) PrimaryType: keep your original blending, but restrict to day-pillar wuxing domain when bazi exists.
  const blendedMain = blendFinalType(quizArchScore, baziPrior, baziBias);
  const allowed = (dayWx ? allowedTypesByWuxing(dayWx) : new Set(Object.keys(CONFIG.type_zh)));
  const primaryType = argmax(blendedMain.finalTypeScore, allowed);

  // 2) SecondaryWanted: use "context" wuxing (down-weight day pillar), to represent outside-world shaping.
  let secondaryWanted = null;
  if (baziInfo) {
    const weightsCtx = [1.0, 1.4, 0.25, 1.0]; // intentionally de-emphasize day pillar for context
    const wxCtx = wuxingFromBaziWithWeights(baziInfo.bazi, weightsCtx);
    const priorCtx = baziPriorArchetype(wxCtx);
    const biasCtx  = baziTypeBias(wxCtx);
    const blendedCtx = blendFinalType(quizArchScore, priorCtx, biasCtx);
    secondaryWanted = argmax(blendedCtx.finalTypeScore); // unrestricted here
  } else {
    // no bazi: secondary = 2nd best from blended main
    const sorted = Object.entries(blendedMain.finalTypeScore).sort((a,b)=>b[1]-a[1]);
    secondaryWanted = sorted[1]?.[0] || primaryType;
  }

  // 3) If primary == secondary => pure-mode (mono-type base only, no evo reference)
  const mode = (secondaryWanted === primaryType) ? "pure" : "dual";

  const domWx = dominantWuxing(wuxingScore);
  const wantedArc = CONFIG.growth_arc_by_top1[top1] || null;

  // Rank candidates
  const ranked = scoreAndRankCandidates(primaryType, secondaryWanted, top1, top2k, domWx, wantedArc, mode);
  const topNList = ranked.slice(0, 6);

  const seed = bitstring(ans) + "|" + baziStr + "|" + primaryType + "|" + secondaryWanted + "|" + (top1||"") + "|" + (top2k||"") + "|" + mode;
  const picked = pickFromTopN(topNList, seed);

  if (!picked) {
    // Dual-mode strict constraint could yield empty set; keep determined primary/secondary and fall back to primary-only selection WITHOUT changing secondary.
    if (mode === "dual") {
      const relaxed = (POOLS[primaryType] || []).slice(0, 60).map((p, idx)=>({idx, pid:p[0], identifier:p[1], zh:p[2]}));
      if (relaxed.length) {
        const h = fnv1a(seed + "|relax");
        const r = relaxed[h % relaxed.length];
        const displayName = r.zh ? `${r.zh}` : r.identifier;
        const subName = r.zh ? `${r.identifier}` : "";
        document.getElementById("result").innerHTML = `
          <div style="font-size:18px;font-weight:900;">${displayName} <span class="mono">${subName? "("+subName+")":""}</span></div>
          <div class="sep"></div>
          <span class="pill">模式：主/副属性（严格）→ 回退</span>
          <span class="pill">主属性：${CONFIG.type_zh[primaryType]}（${primaryType}）</span>
          <span class="pill">副属性：${CONFIG.type_zh[secondaryWanted]}（${secondaryWanted}）</span>
          <div class="sep"></div>
          <div class="small"><strong>回退说明</strong><br/>在当前数据库中，主属性为${CONFIG.type_zh[primaryType]}且进化链可达副属性${CONFIG.type_zh[secondaryWanted]}的候选为空。系统为保证输出稳定：<br/>• 仍保留你确定的副属性（不改写）<br/>• 宝可梦选择回退为“仅按主属性池确定性落点”。</div>
          <div class="sep"></div>
          <div class="small"><strong>主属性生成原因</strong><br/>${primaryReason}</div>
          <div class="sep"></div>
          <div class="small"><strong>副属性生成原因</strong><br/>${secondaryReason}</div>
        `;
        return;
      }
    }
    document.getElementById("result").innerHTML = `<div class="small">该模式下候选为空：请尝试更换生日时间或重置答题。</div>`;
    return;
  }

  // Decide displayed secondary + reasons (never output '无')
  let secondaryReason = "";
  let primaryReason = "";
  let displaySecondary = "—";

  // Primary reason: day pillar restriction + argmax inside allowed set
  if (dayWx) {
    const allowedArr = Array.from(allowed).map(t=>`${CONFIG.type_zh[t]}(${t})`);
    const pScore = blendedMain.finalTypeScore[primaryType] ?? 0;
    primaryReason = `日柱五行=${CONFIG.wuxing_zh[dayWx]}(${dayWx}) → 允许主属性集合=[${allowedArr.join(", ")}]；在该集合内按“答题+八字融合分”取最高：${CONFIG.type_zh[primaryType]}(${primaryType})，分数=${pScore.toFixed(2)}。`;
  } else {
    const pScore = blendedMain.finalTypeScore[primaryType] ?? 0;
    primaryReason = `未填写生日：主属性按“答题+默认融合分”取最高：${CONFIG.type_zh[primaryType]}(${primaryType})，分数=${pScore.toFixed(2)}。`;
  }

  // Secondary is determined BEFORE picking pokemon, and is NEVER overwritten by pokemon properties.
  if (mode === "pure") {
    displaySecondary = `${CONFIG.type_zh[primaryType]}（${primaryType}）`;
    secondaryReason = `主副同源（SecondaryType == PrimaryType）触发“纯属性模式”：仅从初始形态自身为单属性且主属性为${CONFIG.type_zh[primaryType]}的宝可梦中选择。副属性归并为主属性：${CONFIG.type_zh[primaryType]}(${primaryType})。`;
  } else {
    displaySecondary = `${CONFIG.type_zh[secondaryWanted]}（${secondaryWanted}）`;
    secondaryReason = `副属性倾向由“年/月/时柱（弱化日柱）+答题”计算得到：${CONFIG.type_zh[secondaryWanted]}(${secondaryWanted})；随后在挑选宝可梦时强制要求“进化链可达该副属性”，因此副属性不会被宝可梦反向改写。`;
  }

  const displayName = picked.zh ? `${picked.zh}` : picked.identifier;
  const subName = picked.zh ? `${picked.identifier}` : "";
  const reason = picked.why.length ? picked.why.map(x=>`• ${x}`).join("<br/>") : "• 默认规则：属性池内确定性落点";

  document.getElementById("result").innerHTML = `
    <div style="font-size:18px;font-weight:900;">${displayName} <span class="mono">${subName? "(" + subName + ")":""}</span></div>
    <div class="sep"></div>
    <span class="pill">模式：${mode==="pure" ? "纯属性" : "主/副属性"}</span>
    <span class="pill">主属性：${CONFIG.type_zh[primaryType]}（${primaryType}）</span>
    <span class="pill">宝可梦主属性校验：${(BASE_TO_BASE_TYPES[picked.identifier] && BASE_TO_BASE_TYPES[picked.identifier][0]) ? (CONFIG.type_zh[toTitle(BASE_TO_BASE_TYPES[picked.identifier][0])] + "（" + toTitle(BASE_TO_BASE_TYPES[picked.identifier][0]) + "）") : "未知"}</span>
    <span class="pill">副属性：${displaySecondary}</span>
    <span class="pill">Top 原型：${ARCHETYPE_NAMES[top1]} / ${ARCHETYPE_NAMES[top2k]||"—"}</span>
    <span class="pill">日柱五行：${dayWx? (CONFIG.wuxing_zh[dayWx] + "（" + dayWx + "）") : "未填写生日"}</span>
    <div class="sep"></div>
    <div class="small"><strong>为什么是它</strong><br/>${reason}</div>
    <div class="sep"></div>
    <div class="small"><strong>主属性生成原因</strong><br/>${primaryReason}</div>
    <div class="sep"></div>
    <div class="small"><strong>副属性生成原因</strong><br/>${secondaryReason}</div>

    <div class="sep"></div>
    <div class="small"><strong>融合后属性 Top6</strong></div>
    ${renderBars(blendedMain.finalTypeScore, 6)}
    <div class="sep"></div>
    <div class="small"><strong>五行分布</strong>（若填写生日）</div>
    ${wuxingScore ? renderWuxing(wuxingScore) : '<div class="small">未填写生日：跳过八字五行。</div>'}
    <div class="sep"></div>
    <div class="small"><strong>可复现种子</strong><br/><span class="mono">${seed}</span><br/>候选Top6：<span class="mono">${topNList.map(x=>x.identifier).join(", ")}</span></div>
  `;
  document.getElementById("msg").textContent = "";
});

document.getElementById("resetBtn").addEventListener("click", () => {
  renderQuiz();
  document.getElementById("result").innerHTML = "";
  document.getElementById("msg").textContent = "";
  document.getElementById("birthDate").value = "";
  document.getElementById("birthTime").value = "";
});

poolStats();
renderQuiz();
</script>
</body>
</html>
